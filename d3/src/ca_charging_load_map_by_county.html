<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Charging load in CA</title>

    <script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>

    <script type="text/javascript" src="http://use.typekit.com/brf5jpj.js"></script>
    <script src="//use.typekit.net/drk2sev.js"></script>
    <!--<script src="https://cdn.rawgit.com/Gmousse/dataframe-js/master/dist/dataframe-min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/svg.pan-zoom.js/2.7.0/svg.pan-zoom.min.js"></script>-->
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>


    <style type="text/css">

        body {
            margin: 0;
            background-color: #48494B;
            font-family: "proxima-nova", "Source Sans Pro", sans-serif;
        }

        #header-container {
            width: auto;
            margin-left: 5px;
            margin-right: 5px;
            margin-top: 5px;
            padding: 30px;
            overflow:hidden;
            background-color: white;
            box-shadow: 3px 3px 7px #222;
        }

        #container {

            margin-left: 5px;
            margin-right: 5px;
            margin-top: 2px;
            position: relative;
            /*padding: 30px;*/
            overflow:hidden;
            /*background-color: white;*/
            box-shadow: 3px 3px 7px #222;
        }

        #left {
            float: left;
            width: 29.8%;
            height: 600px;
            min-height:10px;
            overflow:hidden;
            /*padding-left:30px;*/
            margin:auto;
            background-color: #ececec;
        }
        #right {
            float: right;
            width: 70%;
            height: 600px;
            overflow:hidden;
            background-color: #696969;
        }
        #cleared {
            clear: both;
        }
        #chargingLoadChart {
            fill: none;
            stroke: steelblue;
            stroke-linejoin: round;
            stroke-linecap: round;
            stroke-width: 1.5;
        }
        #rectToolTip{
            display: block;
            width: 40%;
            height: auto;
            padding: 5px;
            background-color: #fff;
            color: #000;
            fill: #fff;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            -webkit-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            position: relative;
        }
        /*#overlay {*/
            /*width: 100%;*/
            /*height: 100%;*/
            /*display: block;*/
        /*}*/

        h1 {
            font-size: 24px;
            margin: 0;
        }

        p {
            font-size: 16px;
            margin: 15px 0 10px 0;
        }

        /*g{*/
            /*background: #FFF;*/
            /*display:block;*/
            /*width: 100%;*/
            /*height: 100%;*/
        /*}*/

        a {
            color: #799DCB;
            text-decoration: none;
            transition: color .3s, background .3s, border .3s;
        }
        a:hover {
            color: #48494b;
            background: #e7e8e9;
        }

        svg {
            /*background-color: white;*/
            /*padding-left: 20px;*/
            display:block;
            width: 100%;
            height: 100%;
        }

        /*rect{*/
            /*width: auto;*/
            /*height: auto;*/
            /*background: #799dcb;*/
        /*}*/

        path {
            fill: #799dcb;
            stroke: #fff;
            stroke-width: 0.5;
            transition: transform 0.15s;
        }
        path:hover {
            stroke: #FF7F50;
            stroke-width: 1.5;
            cursor:pointer;
            transform: translateX(-3%) translateY(-5%);
        }

        /* Style for Custom Tooltip */
        div.tooltip {
            display: block;
            width: 40%;
            height: auto;
            padding: 5px;
            background-color: #fff;
            color: #000;
            fill: #fff;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            -webkit-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            position: relative;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }



    </style>
</head>
<body>
    <div id="header-container">
        <h1>Charging load by CA county</h1>
        <p>Source: <a href="http://www.beam-model.net/" target="new">Behavior, Energy, Analysis, Mobility Simulator</a></p>
        <!--<hr>-->
    </div>
    <div id="container">
        <div id="left"></div>
        <div id="right"></div>
        <div id="cleared"></div>
    </div>

    <script type="text/javascript">

        //==================================== Define methods =================================================#
        /*
         * Returns selected object on the top layer
         * @returns {*}
         */
        d3.selection.prototype.moveToFront = function() {
            return this.each(function(){
                this.parentNode.appendChild(this);
            });
        };
        /*
         * Return true if the string contains the substring, it
         * @param it
         * @returns {boolean}
         */
        String.prototype.contains = function(it) { return this.indexOf(it) != -1; };

        /*
         * Return true if the array contains the needle as an element
         * @param needle
         * @returns {boolean}
         */
        var contains = function(needle) {
            // Per spec, the way to identify NaN is that it is not equal to itself
            var findNaN = needle !== needle;
            var indexOf;

            if(!findNaN && typeof Array.prototype.indexOf === 'function') {
                indexOf = Array.prototype.indexOf;
            } else {
                indexOf = function(needle) {
                    var i = -1, index = -1;

                    for(i = 0; i < this.length; i++) {
                        var item = this[i];

                        if((findNaN && item !== item) || item === needle) {
                            index = i;
                            break;
                        }
                    }

                    return index;
                };
            }

            return indexOf.call(this, needle) > -1;
        };

        function wrapText(text, width) {
            text.each(function () {
                var text = d3.select(this),
                    words = "Put your mouse cursor over a county to see the charging load!".split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    x = text.attr("x"),
                    y = text.attr("y"),
                    dy = 0, //parseFloat(text.attr("dy")),
                    tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y);
//                        .attr("dy", dy + "em");
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = text.append("tspan")
                            .attr("x", x)
                            .attr("y", y)
                            .attr("dx", (x-tspan.node().getComputedTextLength()))
                            .attr("dy", ++lineNumber * lineHeight + dy + "em")
                            .text(word);
                    }
                }
            });
        }

        //===================================== Main scripts ===========================================#

        var margin = {top: 30, right: 20, bottom: 30, left: 50};

        // Width and height for SVG
        var mapWidth = 760;
        var mapHeight = 600;
        var chartWidth = mapWidth/3;
        var chartHeight = mapHeight/3;
        var lineChartYPosition = chartHeight + 200;
        var lineGraph, ax, ay, xlabel, ylabel,lineLabel,
            chargingLoadTitle, tvCountyName, tvTotalChargingLoad, rectToolTip;

//        var divTooltip = d3.select("#right")
//            .append("div")
//            .attr("class", "tooltip")
//            .style("opacity", 0);

        // Define map projection
        var projection = d3.geo.mercator()
            .center([ -120, 37.5 ]) // x, y
            .translate([ mapWidth/2, mapHeight/2 ])
            .scale([ mapWidth*3.3 ]);

        //Define path generator
        var path = d3.geo.path()
            .projection(projection);

        //Create SVG
        var svgRight = d3.select("#right")
            .append("svg")
            .attr("width", mapWidth)
            .attr("height", mapHeight)
            .attr("background", "#FFF");

        var zoom = d3.behavior.zoom()
            .translate([-100, -250])
            .scale(2,2)
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

        var svgLeft = d3.select("#left")
            .append("svg")
            .attr("width", mapWidth)
            .attr("height", mapHeight);

        var svgMap = svgRight.append("g")
            .attr("id","svgMap")
            .call(zoom)
            .attr("transform","translate(-100,-250)scale(2,2)");

        var svgCountyInfo = svgLeft.append("g")
            .attr("id","svgCountyInfo")
            .attr("transform",
                "translate(" + (margin.left-40) + "," + margin.top + ")");

        var svgLine = svgLeft
            .append("g")
            .attr("id","svgLine")
            .attr("width", chartWidth+200 + margin.left + margin.right)
            .attr("height", chartWidth+200 + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + (margin.left+10) + "," + 120 + ")");

        var mapOverlay = svgMap.append("rect")
            .attr("class","overlay")
            .attr("id","overlay")
            .attr("fill","#696969")
            .attr("display","block")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("transform","translate(-100,-250)scale(2,2)")
            .call(zoom);

        var tvDefaultDisplay = svgLeft.append("text")
            .attr("width","100%")
            .attr("height","100%")
            .attr("font-size","20")
            .attr("text-align","center")
            .attr("transform","translate(20,100)")
            .attr("opacity", "0.5")
            .call(wrapText, 300);

        // Define linear scale for output
        var color = d3.scale.quantize()
            .range(["#758AA8",
                "#4C668C",
                "#2C4770",
                "#2C4900",
                "#051A38"]);

        // Line function
        var lineFunction = d3.svg.line()
                                 .x(function(d) { return x(d.time); })
                                 .y(function(d) { return y(d.chargingLoad); })
                                 .interpolate("linear");

        // Set the ranges
        var x = d3.scale.linear().range([0, chartWidth]);
        var y = d3.scale.linear().range([chartHeight, 0]);

        // Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(5);

        var yAxis = d3.svg.axis().scale(y)
            .orient("left").ticks(5);

        // Load load profile here and set colors to each county based on the daily load sum
        var minVal = 999;
        var maxVal = 0, countyNameClicked, totalLoadClicked;
        d3.csv("aggregateLoadAndNum.csv", function(aggData){
            //Set input domain for color scale
            color.domain([
                d3.min(aggData, function(d) {
                    if(d.chargingLoad < minVal){
                        minVal = d.chargingLoad;
                    }
                    return minVal;
                }),
                d3.max(aggData, function(d) {
                    if(d.chargingLoad > maxVal){
                        maxVal = d.chargingLoad;
                    }
                    return maxVal;
                })
            ]);

            d3.json("CA_counties.zip.geojson", function(json) {
//                console.log(json);
//                console.log(aggData);

                // Parse data from the json file and assign it to json object
                for(var i = 0; i<aggData.length; i ++){
                    var countyName = aggData[i].spatialGroup;
                    var chargingLoad = aggData[i].chargingLoad;
                    var numPlugged = aggData[i].numPlugged;

                    // Find the corresponding state inside the GeoJSON
                    for (var j = 0; j < json.features.length; j++)  {
                        if (countyName.contains(json.features[j].properties.NAME)) {
                            // Copy the data value into the JSON
                            json.features[j].properties.chargingLoad = chargingLoad;
                            json.features[j].properties.numPlugged = numPlugged;
                            break;
                        }
                    }
                }

                // Bind data and create one path per GeoJson feature
                svgMap.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", function(d) {
                        // Get data value
                        var value = d.properties.chargingLoad;
                        if (value) {
                            //If value exists…
                            return color(value);
                        } else {
                            //If value is undefined…
                            return "rgb(213,222,217)";
                        }
                    })
                    .on("mouseover", function(d){ // When mouse is over a county

                        // Hide the default font
                        tvDefaultDisplay.transition()
                            .duration(50)
                            .style("opacity", 0);

                        var xPosition = chartWidth + 150;
                        var yPosition = chartHeight;
                        var sel = d3.select(this);
                        sel.moveToFront();

                        // Show county name on the left
                        if(!countyNameClicked){
                            tvCountyName = svgCountyInfo
                                .append("text")
                                .attr("id","countyName")
                                .attr("color","#000")
                                .attr("font-size","30")
                                .attr("font-weight","bold")
                                .attr("transform", "translate(10,10)")
                                .text(d.properties.NAMELSAD)
                                .transition().duration(500).attr("opacity","0.9");

                            tvTotalChargingLoad = svgCountyInfo
                                .append("text")
                                .attr("id","totalLoad")
                                .attr("color","#000")
                                .attr("font-size","15")
                                .attr("transform", "translate(10,35)")
                                .text("Total Charging Load (kWH): " + d.properties.chargingLoad/4)
                                .transition().duration(500).attr("opacity","0.5");
                        }

                        // Show the simple text tooltip
//                        divTooltip.transition()
//                            .duration(200)
//                            .style("opacity", .9)
//                            .style("left", 10 + "px")
//                            .style("top", 10 + "px");
//                        divTooltip.html("County: " + d.properties.NAME + "</br>" + "ChargingLoad: " + d.properties.chargingLoad);

//                        svgMap.append("rect")
//                            .attr("id","rectToolTip")
//                            .attr("transform","translate(-100,-250)scale(1,1)")
//                            .style("opacity", 0.9);

//                        if(d.properties.chargingLoad){
//                            // load disaggregate charging load csv
//                            var tempLoadObj = {};
//                            var keyList = [];
//
//                            // build temporal load object
//                            d3.csv("run0.3.disaggregateLoadProfile.csv",function(daggData){
//                                for(var i =0 ; i < daggData.length ; i++){
//                                    if(+daggData[i].time >= 27 && +daggData[i].time < 51
//                                        && daggData[i].spatialGroup.contains(d.properties.NAME)){
//
//                                        // Check if the array contains the value
//                                        if(tempLoadObj[daggData[i].time-27]){
//                                            tempLoadObj[daggData[i].time-27].chargingLoad =
//                                                +tempLoadObj[daggData[i].time-27].chargingLoad
//                                                + +daggData[i].chargingLoad;
//                                        }else{
//                                            tempLoadObj[daggData[i].time-27] = {time:daggData[i].time-27, chargingLoad: +daggData[i].chargingLoad};
//                                            keyList.push(daggData[i].time-27);
//                                        }
//                                    }
//                                }
//
//                                // build temporal load list
//                                var tempLoadList = [];
//                                for(var j=0;j<keyList.length;j++){
//                                    tempLoadList.push({time:+tempLoadObj[keyList[j]].time, chargingLoad:+tempLoadObj[keyList[j]].chargingLoad});
//                                }
//                                tempLoadList.forEach(function(d){
//                                   d.time =+d.time;
//                                   d.chargingLoad =+d.chargingLoad;
//                                });
//
//                                // Set domain of x and y axis
//                                x.domain(d3.extent(tempLoadList, function(d) { return +d.time; }));
//                                y.domain([0, d3.max(tempLoadList, function(d) { return +d.chargingLoad; })]);
//
//                                // Draw the line chart
//                                lineGraph = svgLine.append("path")
//                                    .attr("id","chargingLoadChart")
//                                    .attr("d", lineFunction(tempLoadList));
//
//                                // Draw x axis
//                                ax = svgLine.append("g")
//                                    .attr("id","ax")
//                                    .attr("class", "x axis")
//                                    .attr("transform", "translate(0," + chartHeight + ")")
//                                    .attr("text","test")
//                                    .call(xAxis);
//
//                                // Draw y axis
//                                ay = svgLine.append("g")
//                                    .attr("id","ay")
//                                    .attr("class", "y axis")
//                                    .call(yAxis);
//
//                                lineLabel = svgLine.append("text")
//                                    .attr("transform", "translate(" + (chartWidth+2) + "," + (y(tempLoadList[tempLoadList.length-1].chargingLoad)) + ")")
//                                    .attr("id","lineLabel")
//                                    .attr("dy", ".1em")
//                                    .attr("text-anchor", "start")
//                                    .style("fill", "steelblue")
//                                    .style("font-size", "10px")
//                                    .text("Charging Load (kW)");
//
//                                // Add the text label for the x axis
//                                xlabel = svgLine.append("text")
//                                    .attr("transform", "translate(" + (chartWidth/2) + " ," + (chartHeight+3+margin.bottom) + ")")
//                                    .attr("id","xlabel")
//                                    .style("text-anchor", "middle")
//                                    .text("Time (hour)");
//
//                                // Add the text label for the y axis
//                                ylabel = svgLine.append("text")
//                                    .attr("transform", "rotate(-90)")
//                                    .attr("id","ylabel")
//                                    .attr("y", 0 - margin.left)
//                                    .attr("x",0 - (chartHeight / 2))
//                                    .attr("dy", "1em")
//                                    .style("text-anchor", "middle")
//                                    .text("Charging Load (kW)");
//
//                                // Title
//                                chargingLoadTitle = svgLine.append("text")
//                                    .attr("transform", "translate(" + (chartWidth/2) + ",-10)")
//                                    .attr("id","chargingLoadTitle")
//                                    .style("text-anchor", "middle")
//                                    .attr("margin-bottom","10px")
//                                    .text("Charging Load (kW) by site type");
//
//                            });
//                        }
                    })
                    .on("click", function(d){
                        d3.select("#countyName").remove();
                        d3.select("#totalLoad").remove();
                        d3.select("#countyNameClicked").remove();
                        d3.select("#totalLoadClicked").remove();
                        d3.select("#chargingLoadChart").remove();
                        d3.select("#ax").remove();
                        d3.select("#ay").remove();
                        d3.select("#xlabel").remove();
                        d3.select("#ylabel").remove();
                        d3.select("#lineLabel").remove();
                        d3.select("#chargingLoadTitle").remove();

                        countyNameClicked = svgCountyInfo
                            .append("text")
                            .attr("id","countyNameClicked")
                            .attr("color","#000")
                            .attr("font-size","30")
                            .attr("font-weight","bold")
                            .attr("transform", "translate(10,10)")
                            .text(d.properties.NAMELSAD)
                            .transition().duration(500).attr("opacity","0.9");

                        totalLoadClicked = svgCountyInfo
                            .append("text")
                            .attr("id","totalLoadClicked")
                            .attr("color","#000")
                            .attr("font-size","15")
                            .attr("transform", "translate(10,35)")
                            .text("Total Charging Load (kWH): " + d.properties.chargingLoad/4)
                            .transition().duration(500).attr("opacity","0.5");

                        if(d.properties.chargingLoad){
                            // load disaggregate charging load csv
                            var tempLoadObj = {};
                            var keyList = [];

                            // build temporal load object
                            d3.csv("run0.3.disaggregateLoadProfile.csv",function(daggData){
                                for(var i =0 ; i < daggData.length ; i++){
                                    if(+daggData[i].time >= 27 && +daggData[i].time < 51
                                        && daggData[i].spatialGroup.contains(d.properties.NAME)){

                                        // Check if the array contains the value
                                        if(tempLoadObj[daggData[i].time-27]){
                                            tempLoadObj[daggData[i].time-27].chargingLoad =
                                                +tempLoadObj[daggData[i].time-27].chargingLoad
                                                + +daggData[i].chargingLoad;
                                        }else{
                                            tempLoadObj[daggData[i].time-27] = {time:daggData[i].time-27, chargingLoad: +daggData[i].chargingLoad};
                                            keyList.push(daggData[i].time-27);
                                        }
                                    }
                                }

                                // build temporal load list
                                var tempLoadList = [];
                                for(var j=0;j<keyList.length;j++){
                                    tempLoadList.push({time:+tempLoadObj[keyList[j]].time, chargingLoad:+tempLoadObj[keyList[j]].chargingLoad});
                                }
                                tempLoadList.forEach(function(d){
                                    d.time =+d.time;
                                    d.chargingLoad =+d.chargingLoad;
                                });

                                // Set domain of x and y axis
                                x.domain(d3.extent(tempLoadList, function(d) { return +d.time; }));
                                y.domain([0, d3.max(tempLoadList, function(d) { return +d.chargingLoad; })]);

                                // Draw the line chart
                                lineGraph = svgLine.append("path")
                                    .attr("id","chargingLoadChart")
                                    .attr("d", lineFunction(tempLoadList));

                                // Draw x axis
                                ax = svgLine.append("g")
                                    .attr("id","ax")
                                    .attr("class", "x axis")
                                    .attr("transform", "translate(0," + chartHeight + ")")
                                    .attr("font-size",10)
                                    .call(xAxis);

                                // Draw y axis
                                ay = svgLine.append("g")
                                    .attr("id","ay")
                                    .attr("class", "y axis")
                                    .attr("font-size",10)
                                    .call(yAxis);

                                lineLabel = svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth+2) + "," + (y(tempLoadList[tempLoadList.length-1].chargingLoad)) + ")")
                                    .attr("id","lineLabel")
                                    .attr("dy", ".1em")
                                    .attr("text-anchor", "start")
                                    .style("fill", "steelblue")
                                    .style("font-size", "10px")
                                    .text("Charging Load (kW)");

                                // Add the text label for the x axis
                                xlabel = svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth/2) + " ," + (chartHeight+3+margin.bottom) + ")")
                                    .attr("id","xlabel")
                                    .attr("font-size",13)
                                    .style("text-anchor", "middle")
                                    .text("Time (hour)");

                                // Add the text label for the y axis
                                ylabel = svgLine.append("text")
                                    .attr("transform", "rotate(-90)")
                                    .attr("id","ylabel")
                                    .attr("y", 0 - margin.left)
                                    .attr("x",0 - (chartHeight / 2))
                                    .attr("dy", "1em")
                                    .attr("font-size",13)
                                    .style("text-anchor", "middle")
                                    .text("Charging Load (kW)");

                                // Title
                                chargingLoadTitle = svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth/2) + ",-15)")
                                    .attr("id","chargingLoadTitle")
                                    .style("text-anchor", "middle")
                                    .attr("margin-bottom","10px")
                                    .text("Charging Load (kW) by site type");

                            });
                        }

                    })
                    .on("mouseout", function(){ // When mouse leaves
//                        d3.select("#chargingLoadChart").remove();
//                        d3.select("#ax").remove();
//                        d3.select("#ay").remove();
//                        d3.select("#xlabel").remove();
//                        d3.select("#ylabel").remove();
//                        d3.select("#lineLabel").remove();
//                        d3.select("#chargingLoadTitle").remove();
                        d3.select("#countyName").remove();
                        d3.select("#totalLoad").remove();
//                        d3.select("#rectToolTip").remove();
//                        tvDefaultDisplay.transition()
//                            .duration(50)
//                            .style("opacity", 0.5);
                    })
                    .append("title")
                    .text(function(d) { return d.properties.NAME; });

            });
        });

        function zoomed() {
            svgMap.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
//            svgMap.select(".state-border").style("stroke-width", 1.5 / d3.event.scale + "px");
//            svgMap.select(".county-border").style("stroke-width", .5 / d3.event.scale + "px");
        }

    </script>
    </body>
</html>