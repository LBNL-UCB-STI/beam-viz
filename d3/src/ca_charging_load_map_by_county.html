<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Charging load in CA</title>

    <script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>

    <script type="text/javascript" src="http://use.typekit.com/brf5jpj.js"></script>
    <script src="//use.typekit.net/drk2sev.js"></script>
    <script src="https://cdn.rawgit.com/Gmousse/dataframe-js/master/dist/dataframe-min.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>


    <style type="text/css">

        body {
            margin: 0;
            background-color: #48494B;
            font-family: "proxima-nova", "Source Sans Pro", sans-serif;
        }

        #container {
            width: 1500px;
            margin-left: 30px;
            margin-right: auto;
            margin-top: 30px;
            padding: 30px;
            background-color: white;
            box-shadow: 3px 3px 7px #222;
        }

        h1 {
            font-size: 24px;
            margin: 0;
        }

        p {
            font-size: 16px;
            margin: 15px 0 10px 0;
        }

        a {
            color: #799DCB;
            text-decoration: none;
            transition: color .3s, background .3s, border .3s;
        }
        a:hover {
            color: #48494b;
            background: #e7e8e9;
        }

        svg {
            background-color: white;
            padding-left: 20px;
        }

        path {
            fill: #799dcb;
            stroke: #fff;
            transition: transform 0.15s;
        }
        path:hover {
            fill:#48494b;
            cursor:pointer;
            transform: translateX(-3%) translateY(-3%);
        }

        /* Style for Custom Tooltip */
        div.tooltip {
            width: auto;
            height: auto;
            padding: 5px;
            background-color: #fff;
            color: #000;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            -webkit-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            position: absolute;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-linejoin: round;
            stroke-linecap: round;
            stroke-width: 2;
        }

    </style>
</head>
<body>
    <div id="container">
        <h1>Charging load by CA county</h1>
        <p>Source: <a href="http://www.beam-model.net/" target="new">Behavior, Energy, Analysis, Mobility Simulator</a></p>
    </div>

    <script type="text/javascript">

        //==================================== Define methods =================================================#
        /*
         * Returns selected object on the top layer
         * @returns {*}
         */
        d3.selection.prototype.moveToFront = function() {
            return this.each(function(){
                this.parentNode.appendChild(this);
            });
        };
        /*
         * Return true if the string contains the substring, it
         * @param it
         * @returns {boolean}
         */
        String.prototype.contains = function(it) { return this.indexOf(it) != -1; };

        /*
         * Return true if the array contains the needle as an element
         * @param needle
         * @returns {boolean}
         */
        var contains = function(needle) {
            // Per spec, the way to identify NaN is that it is not equal to itself
            var findNaN = needle !== needle;
            var indexOf;

            if(!findNaN && typeof Array.prototype.indexOf === 'function') {
                indexOf = Array.prototype.indexOf;
            } else {
                indexOf = function(needle) {
                    var i = -1, index = -1;

                    for(i = 0; i < this.length; i++) {
                        var item = this[i];

                        if((findNaN && item !== item) || item === needle) {
                            index = i;
                            break;
                        }
                    }

                    return index;
                };
            }

            return indexOf.call(this, needle) > -1;
        };
        //===================================== Main scripts ===========================================#

        // Initialize Dataframe
        var DataFrame = dfjs.DataFrame;

        var margin = {top: 30, right: 20, bottom: 30, left: 50};

        // Width and height for SVG
        var mapWidth = 760;
        var mapHeight = 600;
        var chartWidth = mapWidth/3;
        var chartHeight = mapHeight/3;

        // Define map projection
        var projection = d3.geo.mercator()
            .center([ -120, 37.5 ]) // x, y
            .translate([ mapWidth/2, mapHeight/2 ])
            .scale([ mapWidth*3.3 ]);

        //Define path generator
        var path = d3.geo.path()
            .projection(projection);

        // Append Div for tooltip to SVG
        var div = d3.select("#container")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        //Create SVG
        var svgMap = d3.select("#container")
            .append("svg")
            .attr("class","svgMap")
            .attr("width", mapWidth)
            .attr("height", mapHeight);

        var svgLine = d3.select("#container")
            .append("svg")
            .attr("class","svgLine")
            .attr("width", chartWidth+200 + margin.left + margin.right)
            .attr("height", chartWidth+200 + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Define linear scale for output
        var color = d3.scale.quantize()
            .range(["rgb(0,109,44)","rgb(49,163,84)","rgb(116,196,118)","rgb(186,228,179)","rgb(237,248,233)"]);

        // Sample data for our line
        var lineData = [ { "x": 1,   "y": 5},  { "x": 20,  "y": 20},
                             { "x": 40,  "y": 10}, { "x": 60,  "y": 40},
                             { "x": 80,  "y": 5},  { "x": 100, "y": 60}];

        // Line function
        var lineFunction = d3.svg.line()
                                 .x(function(d) { return x(d.time); })
                                 .y(function(d) { return y(d.chargingLoad); })
                                 .interpolate("linear");

        // Set the ranges
        var x = d3.scale.linear().range([0, chartWidth]);
        var y = d3.scale.linear().range([chartHeight, 0]);

        // Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(5);

        var yAxis = d3.svg.axis().scale(y)
            .orient("left").ticks(5);

        // Load load profile here and set colors to each county based on the daily load sum
        d3.csv("aggregateLoadAndNum.csv", function(aggData){
            //Set input domain for color scale
            color.domain([
                d3.min(aggData, function(d) {
                    var minVal = 999;
                    for(var i =0; i<d.length ; i++){
                        if(d[i].chargingLoad <= minVal){
                            minVal = d[i].chargingLoad;
                        }
                    }
                    return minVal;
                }),
                d3.max(aggData, function(d) {
                    var maxVal = 0;
                    for(var i =0; i<d.length ; i++){
                        if(d[i].chargingLoad >= maxVal){
                            maxVal = d[i].chargingLoad;
                        }
                    }
                    return maxVal;
                })
            ]);

            d3.json("CA_counties.zip.geojson", function(json) {
//                console.log(json);
//                console.log(aggData);

                // Parse data from the json file and assign it to json object
                for(var i = 0; i<aggData.length; i ++){
                    var countyName = aggData[i].spatialGroup;
                    var chargingLoad = aggData[i].chargingLoad;
                    var numPlugged = aggData[i].numPlugged;

                    // Find the corresponding state inside the GeoJSON
                    for (var j = 0; j < json.features.length; j++)  {
                        if (countyName.contains(json.features[j].properties.NAME)) {
                            // Copy the data value into the JSON
                            json.features[j].properties.chargingLoad = chargingLoad;
                            json.features[j].properties.numPlugged = numPlugged;
                            break;
                        }
                    }
                }

                // Bind data and create one path per GeoJson feature
                var lineGraph, ax, ay, xlabel, ylabel,lineLabel;
                svgMap.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("stroke", "#fff")
                    .style("stroke-width", "1")
                    .style("fill", function(d) {
                        // Get data value
                        var value = d.properties.chargingLoad;
                        if (value) {
                            //If value exists…
                            return color(value);
                        } else {
                            //If value is undefined…
                            return "rgb(213,222,217)";
                        }
                    })
                    .on("mouseover", function(d){ // When mouse is over a county
                        var xPosition = chartWidth + 150;
                        var yPosition = chartHeight;
                        var sel = d3.select(this);
                        sel.moveToFront();

                        if(d.properties.chargingLoad){
                            // load disaggregate charging load csv
                            var tempLoadObj = {};
                            var keyList = [];

                            // build temporal load object
                            d3.csv("run0.3.disaggregateLoadProfile.csv",function(daggData){
                                for(var i =0 ; i < daggData.length ; i++){
                                    if(+daggData[i].time >= 27 && +daggData[i].time < 51
                                        && daggData[i].spatialGroup.contains(d.properties.NAME)){

                                        // Check if the array contains the value
                                        if(tempLoadObj[daggData[i].time-27]){
                                            tempLoadObj[daggData[i].time-27].chargingLoad =
                                                +tempLoadObj[daggData[i].time-27].chargingLoad
                                                + +daggData[i].chargingLoad;
                                        }else{
                                            tempLoadObj[daggData[i].time-27] = {time:daggData[i].time-27, chargingLoad: +daggData[i].chargingLoad};
                                            keyList.push(daggData[i].time-27);
                                        }
                                    }
                                }

                                // build temporal load list
                                var tempLoadList = [];
                                for(var j=0;j<keyList.length;j++){
                                    tempLoadList.push({time:+tempLoadObj[keyList[j]].time, chargingLoad:+tempLoadObj[keyList[j]].chargingLoad});
                                }
                                tempLoadList.forEach(function(d){
                                   d.time =+d.time;
                                   d.chargingLoad =+d.chargingLoad;
                                });

                                // Set domain of x and y axis
                                x.domain(d3.extent(tempLoadList, function(d) { return +d.time; }));
                                y.domain([0, d3.max(tempLoadList, function(d) { return +d.chargingLoad; })]);

                                // Draw the line chart
                                lineGraph = svgLine.append("path")
                                    .attr("class","line")
                                    .attr("d", lineFunction(tempLoadList));

                                // Draw x axis
                                ax = svgLine.append("g")
                                    .attr("class", "x axis")
                                    .attr("transform", "translate(0," + chartHeight + ")")
                                    .attr("text","test")
                                    .call(xAxis);

                                // Draw y axis
                                ay = svgLine.append("g")
                                    .attr("class", "y axis")
                                    .call(yAxis);

                                lineLabel = svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth+2) + "," + (y(tempLoadList[tempLoadList.length-1].chargingLoad)) + ")")
                                    .attr("dy", ".1em")
                                    .attr("text-anchor", "start")
                                    .style("fill", "steelblue")
                                    .text("Charging Load (kW)");

                                // Add the text label for the x axis
                                xlabel = svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth / 2) + " ," + (chartHeight+3+margin.bottom) + ")")
                                    .style("text-anchor", "middle")
                                    .text("Time (hour)");

                                // Add the text label for the y axis
                                ylabel = svgLine.append("text")
                                    .attr("transform", "rotate(-90)")
                                    .attr("y", 0 - margin.left)
                                    .attr("x",0 - (chartHeight / 2))
                                    .attr("dy", "1em")
                                    .style("text-anchor", "middle")
                                    .text("Charging Load (kW)");

                            });

                        }else{
                            // Show the simple text tooltip
                            div.transition()
                                .duration(200)
                                .style("opacity", .9)
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px");
                            div.html("County: " + d.properties.NAME + "</br>" + "ChargingLoad: " + d.properties.chargingLoad);
                        }
                    })
                    .on("mouseout", function(){ // When mouse leaves
                        div.transition()
                            .duration(200)
                            .style("opacity", 0);
                        if(lineGraph){
                            lineGraph.transition()
                                .duration(200)
                                .style("opacity", 0);
                            ax.transition()
                                .duration(200)
                                .style("opacity", 0);
                            ay.transition()
                                .duration(200)
                                .style("opacity", 0);
                            xlabel.transition()
                                .duration(200)
                                .style("opacity", 0);
                            ylabel.transition()
                                .duration(200)
                                .style("opacity", 0);
                            lineLabel.transition()
                                .duration(200)
                                .style("opacity", 0);
                        }
                    });

            });
        });

    </script>
    </body>
</html>