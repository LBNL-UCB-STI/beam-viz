<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Charging load in CA</title>

    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="http://use.typekit.com/brf5jpj.js"></script>
    <script src="http://use.typekit.net/drk2sev.js"></script>
    <script src="http://spin.js.org/spin.js"></script>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />
</head>
<body>
    <div id="header-container" >
        <div id="header-left">
            <h1>Charging load by CA county (BEAM output)</h1>
            <p>Source: <a href="http://www.beam-model.net/" target="new">Behavior, Energy, Analysis, Mobility Simulator</a></p>
            <input type="file" id="chargingLoadFile" />

        </div>
        <div id="header-right" align="right">
            <img src="http://res.cloudinary.com/hrscywv4p/image/upload/c_limit,fl_lossy,h_1440,w_720,f_auto,q_auto/v1/992571/beam-logo-filled_rxqvr0.png"
            width="auto" height="54">
        </div>
    </div>
    <div id="container">
        <div id="left"></div>
        <div id="right"></div>
        <div id="cleared"></div>
    </div>

    <script type="text/javascript">

        var opts = {
            lines: 13 // The number of lines to draw
            , length: 28 // The length of each line
            , width: 14 // The line thickness
            , radius: 42 // The radius of the inner circle
            , scale: 1 // Scales overall size of the spinner
            , corners: 1 // Corner roundness (0..1)
            , color: '#000' // #rgb or #rrggbb or array of colors
            , opacity: 0.25 // Opacity of the lines
            , rotate: 0 // The rotation offset
            , direction: 1 // 1: clockwise, -1: counterclockwise
            , speed: 1 // Rounds per second
            , trail: 60 // Afterglow percentage
            , fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
            , zIndex: 2e9 // The z-index (defaults to 2000000000)
            , className: 'spinner' // The CSS class to assign to the spinner
            , top: '50%' // Top position relative to parent
            , left: '50%' // Left position relative to parent
            , shadow: false // Whether to render a shadow
            , hwaccel: false // Whether to use hardware acceleration
            , position: 'absolute' // Element positioning
        }
        var target = document.getElementById("container");
        var spinner = new Spinner().spin(target);
//        spinner.spin(target);

        //==================================== Define methods =================================================#
        /*
         * Returns selected object on the top layer
         * @returns {*}
         */
        d3.selection.prototype.moveToFront = function() {
            return this.each(function(){
                this.parentNode.appendChild(this);
            });
        };
        /*
         * Return true if the string contains the substring, it
         * @param it
         * @returns {boolean}
         */
        String.prototype.contains = function(it) { return this.indexOf(it) != -1; };

        /*
         * Return true if the array contains the needle as an element
         * @param needle
         * @returns {boolean}
         */
        var contains = function(needle) {
            // Per spec, the way to identify NaN is that it is not equal to itself
            var findNaN = needle !== needle;
            var indexOf;

            if(!findNaN && typeof Array.prototype.indexOf === 'function') {
                indexOf = Array.prototype.indexOf;
            } else {
                indexOf = function(needle) {
                    var i = -1, index = -1;

                    for(i = 0; i < this.length; i++) {
                        var item = this[i];

                        if((findNaN && item !== item) || item === needle) {
                            index = i;
                            break;
                        }
                    }

                    return index;
                };
            }

            return indexOf.call(this, needle) > -1;
        };

        /*
         * Wrat text in svg
         */
        function wrapText(text, width) {
            text.each(function () {
                var text = d3.select(this),
                    words = "Click a county to see the charging load!".split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    x = text.attr("x"),
                    y = text.attr("y"),
                    dy = 0, //parseFloat(text.attr("dy")),
                    tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y);
//                        .attr("dy", dy + "em");
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = text.append("tspan")
                            .attr("x", x)
                            .attr("y", y)
                            .attr("dx", (x-tspan.node().getComputedTextLength()))
                            .attr("dy", ++lineNumber * lineHeight + dy + "em")
                            .text(word);
                    }
                }
            });
        }

        /*
         * Initialize charging load map with given input file
         * @param inputFile
         */
        function initChargingLoadMap(inputFile, geoJson){
            spinner.spin(target);

            svgLeft.selectAll("g").remove();
            svgLeft.selectAll("text").remove();
            svgCountyInfo = svgLeft.append("g")
                .attr("id","svgCountyInfo")
                .attr("transform",
                    "translate(" + (margin.left-40) + "," + margin.top + ")");

            svgLine = svgLeft.append("g")
                .attr("id","svgLine")
                .attr("width", chartWidth+200 + margin.left + margin.right)
                .attr("height", chartWidth+200 + margin.top + margin.bottom)
                .attr("transform",
                    "translate(" + (margin.left) + "," + 120 + ")");

            tvDefaultDisplay = svgLeft.append("text")
                .attr("font-size","20")
                .attr("text-align","center")
                .attr("transform","translate(20,100)")
                .attr("opacity", "0.5")
                .call(wrapText, 400);

            d3.csv(inputFile, function(data){

                // GET KEY FOR SPATIAL GROUP, CHARGING LOAD, AND SITE TYPE
                var spatialGroupKey, chargingLoadKey, siteTypeKey;
                for(var c=0;c<data.columns.length;c++){
                    if(data.columns[c].toLowerCase().contains("group")){
                        spatialGroupKey = data.columns[c];
                    }else if(data.columns[c].toLowerCase().contains("load")){
                        chargingLoadKey = data.columns[c];
                    }else if(data.columns[c].toLowerCase().contains("site")){
                        siteTypeKey = data.columns[c];
                    }
                }

                console.log(data);
                var countyKeys = [];
                for(var k=0;k<data.length;k++){
                    // If the county keys does not include the spatial group
                    if(!contains.call(countyKeys, data[k][spatialGroupKey])){
                        countyKeys.push(data[k][spatialGroupKey]);
                    }
                }


                // GET TOTAL ENERGY CONSUMPTION FOR EACH COUNTY
                var aggLoad = [];
                for(var j=0;j<countyKeys.length;j++){
                    var tempAgg = 0;
                    for(var i=0;i<data.length;i++){
                        if(data[i][spatialGroupKey] === countyKeys[j]){
                            tempAgg = +tempAgg + (+data[i][chargingLoadKey]);
                        }
                    }
                    // Check if the key already exists
                    var dupIndex = -1;
                    for(var p=0;p<aggLoad.length;p++){
                        if(aggLoad[p][spatialGroupKey] === countyKeys[j]){
                            dupIndex = p;
                            break;
                        }
                    }

                    if(dupIndex !== -1){
                        aggLoad[dupIndex][chargingLoadKey] = +aggLoad[dupIndex][chargingLoadKey] + tempAgg;
                    }else{
                        aggLoad.push({spatialGroup: countyKeys[j], chargingLoad:tempAgg});
                    }
                }

                //Set input domain for color scale
                color.domain([
                    d3.min(aggLoad, function(d) {
                        if(d.chargingLoad < minVal){
                            minVal = d.chargingLoad;
                        }
                        return minVal;
                    }),
                    d3.max(aggLoad, function(d) {
                        if(d.chargingLoad > maxVal){
                            maxVal = d.chargingLoad;
                        }
                        return maxVal;
                    })
                ]);

                // LOAD GEO JSON
                d3.json("CA_counties.zip.geojson", function(geoJson) {
                    // Parse data from the json file and assign it to json object
                    for(var i = 0; i<aggLoad.length; i ++){
                        var countyName = aggLoad[i].spatialGroup;
                        var chargingLoad = aggLoad[i].chargingLoad;

                        // Find the corresponding state inside the GeoJSON
                        for (var j = 0; j < geoJson.features.length; j++)  {
                            if (countyName.contains(geoJson.features[j].properties.NAME)) {
                                // Copy the data value into the JSON
                                geoJson.features[j].properties[chargingLoadKey] = chargingLoad;
                                break;
                            }
                        }
                    }

                    console.log("here i am!");

                    // Bind data and create one path per GeoJson feature
                    var map = svgRight.select("#svgMap");
                    map.selectAll("path").remove();
                    console.log(map);
//                    map.exit().remove();
                    map.selectAll("path")
                        .data(geoJson.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .style("fill", function(d) {
                            // Get data value
                            var value = d.properties[chargingLoadKey];
                            if (value) {
                                //If value exists…
                                return color(value);
                            } else {
                                //If value is undefined…
                                return "rgb(213,222,217)";
                            }
                        })
                        .on("mouseover", function(d){ // When mouse is over a county

                            // Hide the default font
                            tvDefaultDisplay.transition()
                                .duration(50)
                                .style("opacity", 0);
                            var sel = d3.select(this);
                            sel.moveToFront();

                            // Show county name on the left
                            if(!countyNameClicked){
                                tvCountyName = svgCountyInfo
                                    .append("text")
                                    .attr("id","countyName")
                                    .attr("color","#000")
                                    .attr("font-size","24")
                                    .attr("font-weight","bold")
                                    .attr("transform", "translate(10,10)")
                                    .text(d.properties.NAMELSAD)
                                    .transition().duration(500).attr("opacity","0.9");

                                tvTotalChargingLoad = svgCountyInfo
                                    .append("text")
                                    .attr("id","totalLoad")
                                    .attr("color","#000")
                                    .attr("font-size","15")
                                    .attr("transform", "translate(10,35)")
                                    .text("Total Charging Load (kWH): " +(d.properties[chargingLoadKey]? (d.properties[chargingLoadKey]/4).toFixed(2) : "undefined"))
                                    .transition().duration(500).attr("opacity","0.5");
                            }
                        })
                        .on("click", function(d){
                            d3.select("#countyName").remove();
                            d3.select("#totalLoad").remove();
                            d3.select("#countyNameClicked").remove();
                            d3.select("#totalLoadClicked").remove();
                            d3.select("#svgLine").remove();

                            // County name when a county is clicked
                            countyNameClicked = svgCountyInfo
                                .append("text")
                                .attr("id","countyNameClicked")
                                .attr("color","#000")
                                .attr("font-size","24")
                                .attr("font-weight","bold")
                                .attr("transform", "translate(10,10)")
                                .text(d.properties.NAMELSAD)
                                .transition().duration(500).attr("opacity","0.9");

                            // Total load when a county is clicked
                            totalLoadClicked = svgCountyInfo
                                .append("text")
                                .attr("id","totalLoadClicked")
                                .attr("color","#000")
                                .attr("font-size","15")
                                .attr("transform", "translate(10,35)")
                                .text("Total Charging Load (kWH): " + (d.properties[chargingLoadKey]? (d.properties[chargingLoadKey]/4).toFixed(2) : "undefined"))
                                .transition().duration(500).attr("opacity","0.5");

                            // If the county has charging load

                            if(d.properties[chargingLoadKey]){
                                svgLine = svgLeft
                                    .append("g")
                                    .attr("id","svgLine")
                                    .attr("width", chartWidth+200 + margin.left + margin.right)
                                    .attr("height", chartWidth+200 + margin.top + margin.bottom)
                                    .append("g")
                                    .attr("transform",
                                        "translate(" + (margin.left) + "," + 120 + ")");


                                // load disaggregate charging load csv
                                var tempLoadObj = {};
                                var keyList = [];

                                // Get site type
                                var siteTypesKeys = [];
                                for(var k=0;k<data.length;k++){
                                    if(!contains.call(siteTypesKeys, data[k][siteTypeKey])){
                                        siteTypesKeys.push(data[k][siteTypeKey]);
                                    }
                                }

                                for(var l=0;l<siteTypesKeys.length;l++){
                                    for(var i =0 ; i < data.length ; i++){
                                        if(+data[i].time >= 27 && +data[i].time < 51
                                            && data[i][spatialGroupKey].contains(d.properties.NAME)
                                            && data[i][siteTypeKey].contains(siteTypesKeys[l])
                                        ){
                                            // Check if the array contains the value
                                            if(tempLoadObj[siteTypesKeys[l]]){
                                                if(tempLoadObj[siteTypesKeys[l]][data[i].time-27]){
                                                    tempLoadObj[siteTypesKeys[l]][data[i].time-27][chargingLoadKey] =
                                                        +tempLoadObj[siteTypesKeys[l]][data[i].time-27][chargingLoadKey]
                                                        + +data[i][chargingLoadKey];
                                                }else{
                                                    tempLoadObj[siteTypesKeys[l]][data[i].time-27] = {siteType: siteTypesKeys[l], time:data[i].time-27, chargingLoad: +data[i][chargingLoadKey]};
                                                    if(l===0) keyList.push(data[i].time-27);
                                                }
                                            }else{
                                                tempLoadObj[siteTypesKeys[l]] = {};
                                                tempLoadObj[siteTypesKeys[l]][data[i].time-27] = {siteType: siteTypesKeys[l], time:data[i].time-27, chargingLoad: +data[i][chargingLoadKey]};
                                                if(l===0) keyList.push(data[i].time-27);
                                            }
                                        }
                                    }
                                }

                                // build temporal load list
                                var tempLoadList = [];
                                for(var j=0;j<keyList.length;j++){
                                    var obj = {};
                                    obj["time"] = +keyList[j];
                                    for(var m=0;m<siteTypesKeys.length;m++){
                                        obj[siteTypesKeys[m]]= +tempLoadObj[siteTypesKeys[m]][keyList[j]].chargingLoad;
                                    }
                                    tempLoadList.push(obj);
                                }

                                var siteTypes = siteTypesKeys.map(function(id) {
                                    return {
                                        id: id,
                                        values: tempLoadList.map(function(d) {
                                            return {time: d.time, chargingLoad: d[id]};
                                        })
                                    };
                                });

                                x.domain(d3.extent(tempLoadList, function(d) { return d.time; }));
                                y.domain([
                                    d3.min(siteTypes, function(c) { return d3.min(c.values, function(d) { return d.chargingLoad; }); }),
                                    d3.max(siteTypes, function(c) { return d3.max(c.values, function(d) { return d.chargingLoad; }); })
                                ]);
                                z.domain(siteTypes.map(function(c) { return c.id; }));

                                // Title
                                svgLine.append("text")
                                    .attr("transform", "translate(" + (chartWidth/2) + ",-15)")
                                    .attr("id","chargingLoadTitle")
                                    .style("text-anchor", "middle")
                                    .attr("margin-bottom","10px")
                                    .text("Charging Load (kW) by site type");

                                svgLine.append("g")
                                    .attr("class", "axis axis--x")
                                    .attr("transform", "translate(0," + chartHeight + ")")
                                    .call(d3.axisBottom(x))
                                    .append("text")
                                    .attr("x", 11)
                                    .attr("dx", "10.8em")
                                    .attr("dy", "2.8em")
                                    .attr("fill", "#000")
                                    .text("Time, hour");;

                                svgLine.append("g")
                                    .attr("class", "axis axis--y")
                                    .call(d3.axisLeft(y))
                                    .append("text")
                                    .attr("transform", "rotate(-90)")
                                    .attr("y", 6)
                                    //                                    .attr("dx", "1.8em")
                                    .attr("dy", "-3.5em")
                                    .attr("fill", "#000")
                                    .text("Charging Load, kW");

                                var siteType = svgLine.selectAll("siteType")
                                    .data(siteTypes)
                                    .enter().append("g")
                                    .attr("class", "siteType");

                                siteType.append("path")
                                    .attr("class", "line")
                                    .attr("id","chargingLoadChart")
                                    .attr("d", function(d) { return lineFunction(d.values); })
                                    .style("stroke", function(d) { return z(d.id); });

                                siteType.append("text")
                                    .datum(function(d) { return {id: d.id, value: d.values[d.values.length - 1]}; })
                                    .attr("transform", function(d) { return "translate(" + x(d.value.time) + "," + y(d.value.chargingLoad) + ")"; })
                                    .attr("x", 3)
                                    .attr("dy", "0.35em")
                                    .style("font", "10px sans-serif")
                                    .text(function(d) { return d.id; });
                            }

                        })
                        .on("mouseout", function(){ // When mouse leaves
                            d3.select("#countyName").remove();
                            d3.select("#totalLoad").remove();
                            if(!countyNameClicked){
                                tvDefaultDisplay.transition()
                                    .duration(50)
                                    .style("opacity", 0.5);
                            }
                        })
                        .append("title")
                        .text(function(d) { return d.properties.NAME; });
                    map.transition().duration(500);
                    console.log(map);
                });

                spinner.stop();
            });
        }

        /*
         * Call back function when a file selected
         */
        jQuery("input#chargingLoadFile").change(function (event) {
            initChargingLoadMap(URL.createObjectURL(event.target.files[0]));
        });

        //===================================== Main scripts ===========================================#

        // GLOBAL VARIABLES

        var margin = {top: 30, right: 20, bottom: 30, left: 50};

        // Width and height for SVG
        var mapWidth = 760;
        var mapHeight = 600;
        var chartWidth = mapWidth/3;
        var chartHeight = mapHeight/3;
        var chargingLoadTitle, tvCountyName, tvTotalChargingLoad;

        // Define map projection
        var projection = d3.geoMercator()
            .center([ -120, 37.5 ]) // x, y
            .translate([ mapWidth/2, mapHeight/2 ])
            .scale([ mapWidth*3.3 ]);

        //Define path generator
        var path = d3.geoPath()
            .projection(projection);


        // ============= div left ============//
        var svgLeft = d3.select("#left")
            .append("svg:svg")
            .attr("id","svgLeft")
            .attr("display","block");

        var svgCountyInfo = svgLeft.append("g")
            .attr("id","svgCountyInfo")
            .attr("transform",
                "translate(" + (margin.left-40) + "," + margin.top + ")");

        var svgLine = svgLeft
            .append("g")
            .attr("id","svgLine")
            .attr("width", chartWidth+200 + margin.left + margin.right)
            .attr("height", chartWidth+200 + margin.top + margin.bottom)
            .attr("transform",
                "translate(" + (margin.left) + "," + 120 + ")");

        var tvDefaultDisplay = svgLeft.append("text")
            .attr("font-size","20")
            .attr("text-align","center")
            .attr("transform","translate(20,100)")
            .attr("opacity", "0.5")
            .call(wrapText, 400);


        // ============= div right ============//
        var svgRight = d3.select("#right")
            .append("svg:svg")
            .attr("id","svgLeft")
            .attr("background", "#FFF");
        var svgMap = svgRight.append("g").attr("id","svgMap");
        var zoom = d3.zoom()
            .scaleExtent([0, 8])
            .on("zoom", function() {
                svgMap.attr("transform", d3.event.transform);
            });

        svgMap.append("rect")
            .attr("class","overlay")
            .attr("id","overlay")
            .attr("fill","#696969")
            .attr("display","block")
            .attr("width", "100%")
            .attr("height", "100%")
            .call(zoom)
            .call(zoom.transform, d3.zoomIdentity.translate(-200,-300).scale(2,2));

        d3.json("CA_counties.zip.geojson", function(json) {
            svgMap.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", function(d) {
                    return "rgb(213,222,217)";
                });
        });

        // Define linear scale for output
        var color = d3.scaleLinear()
            .range(["#FFAAAA",
                "#550000"]);

        // Line function
        var lineFunction = d3.line()
            .curve(d3.curveBasis)
             .x(function(d) { return x(d.time); })
             .y(function(d) { return y(d.chargingLoad); });

        // Set the ranges
        var x = d3.scaleLinear().range([0, chartWidth]),
            y = d3.scaleLinear().range([chartHeight, 0]),
            z = d3.scaleOrdinal(d3.schemeCategory10);

        // Load load profile here and set colors to each county based on the daily load sum
        var minVal = 999;
        var maxVal = 0, countyNameClicked, totalLoadClicked;

        spinner.stop();
    </script>
    </body>
</html>